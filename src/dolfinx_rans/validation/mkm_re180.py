"""
MKM DNS data for Re_tau = 180 channel flow.

Reference:
Moser, R.D., Kim, J., Mansour, N.N. (1999).
"DNS of turbulent channel flow up to Re_τ = 590"
Physics of Fluids, 11(4):943-945.

Data from: https://turbulence.oden.utexas.edu/
"""

import numpy as np

# Re_tau = 180 channel flow DNS
RE_TAU = 180

# Mean velocity profile: U+ vs y+
# Columns: y+, U+
MEAN_VELOCITY = np.array([
    [0.0000, 0.0000],
    [0.5533, 0.5528],
    [1.1066, 1.1040],
    [1.6599, 1.6510],
    [2.2132, 2.1898],
    [2.7665, 2.7159],
    [3.3198, 3.2246],
    [4.4264, 4.1804],
    [5.5330, 5.0443],
    [6.6396, 5.8189],
    [7.7462, 6.5102],
    [8.8528, 7.1255],
    [9.9594, 7.6727],
    [11.066, 8.1598],
    [12.173, 8.5944],
    [13.279, 8.9836],
    [14.386, 9.3337],
    [15.493, 9.6504],
    [16.599, 9.9388],
    [17.706, 10.202],
    [19.919, 10.668],
    [22.132, 11.068],
    [24.346, 11.415],
    [26.559, 11.719],
    [28.772, 11.988],
    [30.986, 12.229],
    [33.199, 12.446],
    [35.412, 12.642],
    [37.625, 12.821],
    [39.839, 12.985],
    [44.265, 13.278],
    [48.691, 13.531],
    [53.118, 13.757],
    [57.544, 13.959],
    [61.970, 14.143],
    [66.396, 14.311],
    [70.823, 14.466],
    [75.249, 14.610],
    [79.675, 14.744],
    [84.101, 14.868],
    [88.528, 14.985],
    [97.380, 15.200],
    [106.23, 15.393],
    [115.09, 15.566],
    [123.94, 15.724],
    [132.79, 15.868],
    [141.65, 15.999],
    [150.50, 16.121],
    [159.36, 16.233],
    [168.21, 16.336],
    [177.07, 16.430],
    [180.00, 16.465],
])

# Reynolds stresses (normalized by u_tau^2)
# Columns: y+, uu+, vv+, ww+, uv+
REYNOLDS_STRESSES = np.array([
    [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
    [0.5533, 0.0169, 0.0001, 0.0020, -0.0002],
    [1.1066, 0.0651, 0.0005, 0.0077, -0.0013],
    [1.6599, 0.1404, 0.0013, 0.0167, -0.0037],
    [2.2132, 0.2378, 0.0027, 0.0286, -0.0079],
    [2.7665, 0.3516, 0.0047, 0.0430, -0.0142],
    [3.3198, 0.4761, 0.0074, 0.0595, -0.0228],
    [4.4264, 0.7451, 0.0146, 0.0982, -0.0461],
    [5.5330, 1.0199, 0.0243, 0.1425, -0.0766],
    [6.6396, 1.2844, 0.0362, 0.1913, -0.1124],
    [7.7462, 1.5279, 0.0501, 0.2433, -0.1515],
    [8.8528, 1.7449, 0.0657, 0.2975, -0.1923],
    [9.9594, 1.9339, 0.0828, 0.3528, -0.2333],
    [11.066, 2.0956, 0.1010, 0.4083, -0.2735],
    [12.173, 2.2322, 0.1202, 0.4634, -0.3121],
    [13.279, 2.3463, 0.1401, 0.5174, -0.3486],
    [14.386, 2.4409, 0.1606, 0.5697, -0.3826],
    [15.493, 2.5186, 0.1814, 0.6200, -0.4138],
    [16.599, 2.5823, 0.2025, 0.6680, -0.4422],
    [17.706, 2.6341, 0.2236, 0.7135, -0.4679],
    [19.919, 2.7108, 0.2659, 0.7976, -0.5120],
    [22.132, 2.7599, 0.3076, 0.8724, -0.5478],
    [24.346, 2.7886, 0.3479, 0.9382, -0.5767],
    [26.559, 2.8029, 0.3864, 0.9956, -0.5998],
    [28.772, 2.8076, 0.4229, 1.0455, -0.6182],
    [30.986, 2.8059, 0.4572, 1.0886, -0.6326],
    [33.199, 2.8003, 0.4894, 1.1258, -0.6439],
    [35.412, 2.7924, 0.5193, 1.1576, -0.6525],
    [37.625, 2.7833, 0.5472, 1.1849, -0.6591],
    [39.839, 2.7737, 0.5730, 1.2083, -0.6640],
    [44.265, 2.7539, 0.6193, 1.2455, -0.6702],
    [48.691, 2.7356, 0.6594, 1.2725, -0.6729],
    [53.118, 2.7192, 0.6939, 1.2917, -0.6729],
    [57.544, 2.7049, 0.7232, 1.3050, -0.6710],
    [61.970, 2.6925, 0.7479, 1.3137, -0.6677],
    [66.396, 2.6818, 0.7685, 1.3189, -0.6635],
    [70.823, 2.6726, 0.7854, 1.3214, -0.6586],
    [75.249, 2.6646, 0.7992, 1.3221, -0.6534],
    [79.675, 2.6577, 0.8101, 1.3214, -0.6480],
    [84.101, 2.6516, 0.8184, 1.3198, -0.6426],
    [88.528, 2.6463, 0.8246, 1.3177, -0.6373],
    [97.380, 2.6373, 0.8317, 1.3130, -0.6274],
    [106.23, 2.6301, 0.8338, 1.3081, -0.6186],
    [115.09, 2.6242, 0.8321, 1.3038, -0.6110],
    [123.94, 2.6195, 0.8275, 1.3004, -0.6045],
    [132.79, 2.6155, 0.8207, 1.2980, -0.5992],
    [141.65, 2.6123, 0.8124, 1.2969, -0.5949],
    [150.50, 2.6095, 0.8031, 1.2969, -0.5917],
    [159.36, 2.6073, 0.7933, 1.2982, -0.5895],
    [168.21, 2.6054, 0.7836, 1.3007, -0.5881],
    [177.07, 2.6039, 0.7744, 1.3044, -0.5875],
    [180.00, 2.6033, 0.7707, 1.3064, -0.5874],
])

# Turbulent kinetic energy: k+ = 0.5*(uu+ + vv+ + ww+)
# Computed from Reynolds stresses
def get_k_profile():
    """Return y+, k+ profile."""
    y_plus = REYNOLDS_STRESSES[:, 0]
    uu = REYNOLDS_STRESSES[:, 1]
    vv = REYNOLDS_STRESSES[:, 2]
    ww = REYNOLDS_STRESSES[:, 3]
    k_plus = 0.5 * (uu + vv + ww)
    return y_plus, k_plus


# Dissipation rate (approximate from balance)
# For channel flow: ε+ ≈ production at equilibrium
# P+ = -uv+ * dU+/dy+
def get_epsilon_profile():
    """Return y+, eps+ profile (approximate from production)."""
    y_plus = REYNOLDS_STRESSES[:, 0]
    uv = REYNOLDS_STRESSES[:, 4]

    # Compute dU+/dy+ from mean velocity
    U_plus = np.interp(y_plus, MEAN_VELOCITY[:, 0], MEAN_VELOCITY[:, 1])
    dUdy = np.gradient(U_plus, y_plus)

    # Production P+ = -uv+ * dU+/dy+
    P_plus = -uv * dUdy

    # Approximate: ε+ ≈ P+ at equilibrium
    eps_plus = np.maximum(P_plus, 1e-10)
    return y_plus, eps_plus


# Convert to physical units
def to_physical(y_plus_data, phi_plus_data, u_tau, nu):
    """
    Convert from wall units to physical units.

    Args:
        y_plus_data: y+ values
        phi_plus_data: φ+ values (velocity, k, etc.)
        u_tau: friction velocity
        nu: kinematic viscosity

    Returns:
        y: physical y coordinates
        phi: physical values
    """
    delta_nu = nu / u_tau  # viscous length scale
    y = y_plus_data * delta_nu

    # Scaling depends on quantity:
    # U = U+ * u_tau
    # k = k+ * u_tau^2
    # ε = ε+ * u_tau^4 / nu

    return y, phi_plus_data


if __name__ == "__main__":
    # Test data loading
    y_plus, k_plus = get_k_profile()
    print(f"k+ profile: y+ from {y_plus[0]:.2f} to {y_plus[-1]:.2f}")
    print(f"k+ max = {k_plus.max():.3f} at y+ = {y_plus[k_plus.argmax()]:.1f}")

    y_plus, eps_plus = get_epsilon_profile()
    print(f"ε+ max = {eps_plus.max():.4f} at y+ = {y_plus[eps_plus.argmax()]:.1f}")
