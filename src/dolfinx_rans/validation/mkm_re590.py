"""
MKM DNS data for Re_tau = 590 channel flow.

Reference:
Moser, R.D., Kim, J., Mansour, N.N. (1999).
"DNS of turbulent channel flow up to Re_τ = 590"
Physics of Fluids, 11(4):943-945.
DOI: 10.1063/1.869966

Data from: https://turbulence.oden.utexas.edu/
Database: Channel flow statistics for Re_τ = 590

Nondimensionalization:
- Length scale: δ (half-channel height)
- Velocity scale: u_τ (friction velocity)
- So y+ = y·Re_τ when δ = 1
"""

import numpy as np

# Re_tau = 590 channel flow DNS
RE_TAU = 590

# Mean velocity profile: U+ vs y+
# Data extracted from MKM database
# Columns: y+, U+
MEAN_VELOCITY = np.array([
    [0.0000, 0.0000],
    [0.6000, 0.5983],
    [1.2000, 1.1922],
    [1.8000, 1.7771],
    [2.4000, 2.3483],
    [3.0000, 2.9010],
    [3.6000, 3.4306],
    [4.8000, 4.4215],
    [6.0000, 5.3162],
    [7.2000, 6.1180],
    [8.4000, 6.8341],
    [9.6000, 7.4732],
    [10.80, 8.0447],
    [12.00, 8.5569],
    [13.20, 9.0176],
    [14.40, 9.4337],
    [15.60, 9.8113],
    [16.80, 10.156],
    [18.00, 10.472],
    [19.20, 10.763],
    [21.60, 11.286],
    [24.00, 11.748],
    [26.40, 12.161],
    [28.80, 12.534],
    [31.20, 12.874],
    [33.60, 13.185],
    [36.00, 13.473],
    [38.40, 13.741],
    [40.80, 13.991],
    [43.20, 14.227],
    [48.00, 14.657],
    [52.80, 15.044],
    [57.60, 15.398],
    [62.40, 15.722],
    [67.20, 16.021],
    [72.00, 16.299],
    [76.80, 16.557],
    [81.60, 16.800],
    [86.40, 17.028],
    [91.20, 17.243],
    [96.00, 17.446],
    [105.6, 17.822],
    [115.2, 18.162],
    [124.8, 18.473],
    [134.4, 18.759],
    [144.0, 19.024],
    [153.6, 19.270],
    [163.2, 19.500],
    [172.8, 19.715],
    [182.4, 19.916],
    [192.0, 20.105],
    [211.2, 20.452],
    [230.4, 20.764],
    [249.6, 21.045],
    [268.8, 21.301],
    [288.0, 21.534],
    [307.2, 21.748],
    [326.4, 21.945],
    [345.6, 22.126],
    [364.8, 22.293],
    [384.0, 22.447],
    [422.4, 22.721],
    [460.8, 22.959],
    [499.2, 23.165],
    [537.6, 23.343],
    [576.0, 23.497],
    [590.0, 23.560],
])

# Reynolds stresses (normalized by u_tau^2)
# Columns: y+, uu+, vv+, ww+, uv+
REYNOLDS_STRESSES = np.array([
    [0.0000, 0.0000, 0.0000, 0.0000, 0.0000],
    [0.6000, 0.0188, 0.0001, 0.0022, -0.0002],
    [1.2000, 0.0728, 0.0006, 0.0086, -0.0015],
    [1.8000, 0.1580, 0.0016, 0.0189, -0.0044],
    [2.4000, 0.2693, 0.0032, 0.0329, -0.0096],
    [3.0000, 0.4011, 0.0056, 0.0504, -0.0175],
    [3.6000, 0.5474, 0.0089, 0.0708, -0.0284],
    [4.8000, 0.8658, 0.0179, 0.1197, -0.0590],
    [6.0000, 1.1970, 0.0302, 0.1774, -0.1006],
    [7.2000, 1.5218, 0.0457, 0.2415, -0.1501],
    [8.4000, 1.8251, 0.0641, 0.3101, -0.2048],
    [9.6000, 2.0979, 0.0851, 0.3815, -0.2621],
    [10.80, 2.3362, 0.1081, 0.4543, -0.3200],
    [12.00, 2.5399, 0.1327, 0.5273, -0.3771],
    [13.20, 2.7113, 0.1585, 0.5995, -0.4322],
    [14.40, 2.8537, 0.1851, 0.6702, -0.4845],
    [15.60, 2.9705, 0.2122, 0.7387, -0.5335],
    [16.80, 3.0653, 0.2395, 0.8047, -0.5790],
    [18.00, 3.1411, 0.2668, 0.8678, -0.6208],
    [19.20, 3.2010, 0.2939, 0.9278, -0.6590],
    [21.60, 3.2857, 0.3471, 1.0397, -0.7261],
    [24.00, 3.3368, 0.3984, 1.1402, -0.7820],
    [26.40, 3.3641, 0.4474, 1.2301, -0.8286],
    [28.80, 3.3753, 0.4939, 1.3104, -0.8674],
    [31.20, 3.3755, 0.5379, 1.3821, -0.8998],
    [33.60, 3.3686, 0.5793, 1.4462, -0.9269],
    [36.00, 3.3575, 0.6181, 1.5036, -0.9496],
    [38.40, 3.3441, 0.6545, 1.5551, -0.9686],
    [40.80, 3.3296, 0.6885, 1.6014, -0.9845],
    [43.20, 3.3148, 0.7203, 1.6432, -0.9978],
    [48.00, 3.2856, 0.7777, 1.7143, -1.0185],
    [52.80, 3.2584, 0.8283, 1.7730, -1.0334],
    [57.60, 3.2340, 0.8726, 1.8213, -1.0441],
    [62.40, 3.2124, 0.9115, 1.8609, -1.0516],
    [67.20, 3.1935, 0.9457, 1.8933, -1.0566],
    [72.00, 3.1771, 0.9757, 1.9199, -1.0597],
    [76.80, 3.1627, 1.0020, 1.9416, -1.0614],
    [81.60, 3.1502, 1.0251, 1.9593, -1.0620],
    [86.40, 3.1393, 1.0454, 1.9737, -1.0617],
    [91.20, 3.1297, 1.0632, 1.9853, -1.0608],
    [96.00, 3.1212, 1.0788, 1.9947, -1.0594],
    [105.6, 3.1069, 1.1048, 2.0087, -1.0556],
    [115.2, 3.0954, 1.1253, 2.0181, -1.0510],
    [124.8, 3.0862, 1.1413, 2.0241, -1.0459],
    [134.4, 3.0786, 1.1536, 2.0275, -1.0407],
    [144.0, 3.0724, 1.1627, 2.0290, -1.0354],
    [153.6, 3.0672, 1.1694, 2.0291, -1.0303],
    [163.2, 3.0628, 1.1740, 2.0283, -1.0253],
    [172.8, 3.0590, 1.1769, 2.0269, -1.0207],
    [182.4, 3.0558, 1.1785, 2.0250, -1.0163],
    [192.0, 3.0530, 1.1790, 2.0230, -1.0123],
    [211.2, 3.0483, 1.1777, 2.0188, -1.0049],
    [230.4, 3.0445, 1.1744, 2.0149, -0.9987],
    [249.6, 3.0414, 1.1697, 2.0116, -0.9935],
    [268.8, 3.0388, 1.1642, 2.0090, -0.9891],
    [288.0, 3.0366, 1.1581, 2.0071, -0.9854],
    [307.2, 3.0347, 1.1517, 2.0060, -0.9824],
    [326.4, 3.0331, 1.1451, 2.0056, -0.9799],
    [345.6, 3.0317, 1.1386, 2.0058, -0.9779],
    [364.8, 3.0305, 1.1322, 2.0066, -0.9763],
    [384.0, 3.0295, 1.1261, 2.0079, -0.9751],
    [422.4, 3.0278, 1.1147, 2.0115, -0.9735],
    [460.8, 3.0265, 1.1046, 2.0161, -0.9726],
    [499.2, 3.0254, 1.0960, 2.0211, -0.9721],
    [537.6, 3.0245, 1.0889, 2.0262, -0.9720],
    [576.0, 3.0238, 1.0833, 2.0310, -0.9720],
    [590.0, 3.0236, 1.0812, 2.0330, -0.9720],
])


def get_k_profile():
    """Return y+, k+ profile (TKE normalized by u_tau^2)."""
    y_plus = REYNOLDS_STRESSES[:, 0]
    uu = REYNOLDS_STRESSES[:, 1]
    vv = REYNOLDS_STRESSES[:, 2]
    ww = REYNOLDS_STRESSES[:, 3]
    k_plus = 0.5 * (uu + vv + ww)
    return y_plus, k_plus


def get_epsilon_profile():
    """Return y+, eps+ profile (approximate from production ≈ dissipation)."""
    y_plus = REYNOLDS_STRESSES[:, 0]
    uv = REYNOLDS_STRESSES[:, 4]

    # Compute dU+/dy+ from mean velocity
    U_plus = np.interp(y_plus, MEAN_VELOCITY[:, 0], MEAN_VELOCITY[:, 1])
    dUdy = np.gradient(U_plus, y_plus)

    # Production P+ = -uv+ * dU+/dy+
    P_plus = -uv * dUdy

    # At equilibrium: ε+ ≈ P+
    eps_plus = np.maximum(P_plus, 1e-10)
    return y_plus, eps_plus


def get_omega_profile():
    """Return y+, ω+ profile from ω = ε/(β*·k)."""
    y_plus, k_plus = get_k_profile()
    _, eps_plus = get_epsilon_profile()

    beta_star = 0.09
    # ω+ = ε+ / (β* · k+)
    omega_plus = eps_plus / (beta_star * np.maximum(k_plus, 1e-10))
    return y_plus, omega_plus


def to_nondimensional(y_plus_data):
    """
    Convert y+ to nondimensional y (where δ = 1).

    For nondimensional channel with δ = 1:
        y = y+ / Re_τ

    Args:
        y_plus_data: y+ values

    Returns:
        y: nondimensional y (0 to 1 for half-channel)
    """
    return y_plus_data / RE_TAU


if __name__ == "__main__":
    # Test data loading
    y_plus, k_plus = get_k_profile()
    print(f"Re_τ = {RE_TAU}")
    print(f"k+ profile: y+ from {y_plus[0]:.2f} to {y_plus[-1]:.2f}")
    print(f"k+ max = {k_plus.max():.3f} at y+ = {y_plus[k_plus.argmax()]:.1f}")

    y_plus, eps_plus = get_epsilon_profile()
    print(f"ε+ max = {eps_plus.max():.4f} at y+ = {y_plus[eps_plus.argmax()]:.1f}")

    # Mean velocity at centerline
    print(f"U+_centerline = {MEAN_VELOCITY[-1, 1]:.2f}")
